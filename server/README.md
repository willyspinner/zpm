# shamrock-backend

# file structure

main file : `app.js (binds routes, initialize database connections)`

```
src (folder)
src/db (folder)         - defines initial connection to DB and DB queries. Doesn't involve application logic at all - just involved with database.
src/payments (folder)   - defines payment methods
src/routes (folder)   - defines route handlers
src/utils (folder)      - defines miscellaneous utilities (e.g. check if environment variables are all properly set)
tests (folder) - testing
tests/e2e_int_tests(folder) - end to end Integration API testing (using a HTTP client).
tests/load_tests(folder) - API load testing (using a HTTP client).
 ```

# Commands

|command|description|
|-|-|
| `node app.js` | run app in single process mode - (need elasticsearch, postgresql online, and env variables defined properly as per sample_env_file). |
| `node clustered_app.js` | run app in clustered mode - (same requirements as above apply). |
| `npm test `| e2e integration tests & code coverage, with mock stripe. |
| `npm run e2e-test-stripe`| e2e integration tests & code coverage, with stripe TEST API key and fake card tokens.|
| `npm run gen-nyc` | Generate coverage in very-interactive line-by-line HTML viewer. Serve coverage folder as root of web server to see online in html.'",
| `npm run swag-server`| run a localhost swagger server on port 7500 containing API endpoint docs (written inline), AND coverage.|
| `npm run swag-daemon`| same as `swag-server`, but ran as a daemon, with possword protection. Writes PID file in `(root-directory-of-this-project)/swagger_daemon.pid`. |
| `npm run gen-doc` | compiles all swagger API docs to a markdown file. |
| `npm run locust-search` | load-test (UI available in `localhost:8089`) search routes (needs app to run). |


# Documentation
see https://api-docs.from-ca.com.

Credentials are posted in slack. Contact Wilson for more info.

# TODO lists
See `.vscode/vscode-kanban.json` for a list of things that we're planning on doing, doing, testing and already finished.

# code coverage
(generated by istanbul)
### We have 62.3% total Coverage.

|File                                  |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |
|-|-|-|-|-|-|
|All files                             |     62.3 |    32.59 |    68.39 |    62.38 |                   |
| shamrock-backend                     |    74.03 |       50 |    33.33 |       76 |                   |
|  app.js                              |    74.03 |       50 |    33.33 |       76 |... 16,117,119,120 |
| shamrock-backend/src/db              |     52.7 |       26 |    45.16 |     52.7 |                   |
|  buynow.js                           |     8.33 |        0 |        0 |     8.33 |... 77,79,81,83,85 |
|  db.js                               |    88.89 |      100 |       50 |    88.89 |          13,14,23 |
|  dbutils.js                          |      100 |      100 |      100 |      100 |                   |
|  page.js                             |    27.27 |        0 |        0 |    27.27 |... 28,29,30,31,33 |
|  pledge.js                           |    20.69 |        0 |        0 |    20.69 |... 47,50,51,52,54 |
|  product.js                          |    27.78 |        0 |        0 |    27.78 |... 20,21,22,23,25 |
|  test.js                             |    85.71 |      100 |    71.43 |    85.71 |          17,18,43 |
|  user.js                             |    77.42 |    56.25 |    77.78 |    77.42 |... 91,129,136,137 |
| shamrock-backend/src/log             |       28 |     8.33 |       25 |       25 |                   |
|  logger.js                           |       28 |     8.33 |       25 |       25 |... 29,30,31,40,55 |
| shamrock-backend/src/payments        |       50 |    23.08 |       50 |       50 |                   |
|  charge.js                           |    33.33 |        0 |        0 |    33.33 |   8,9,15,26,27,29 |
|  customer_source.js                  |    58.82 |    33.33 |    66.67 |    58.82 |... 43,52,56,70,71 |
| shamrock-backend/src/routes          |    45.23 |    35.71 |       40 |    45.19 |                   |
|  buynow.js                           |    16.67 |        0 |        0 |    17.07 |... 24,125,128,130 |
|  middleware.js                       |      100 |      100 |      100 |      100 |                   |
|  page.js                             |    23.53 |        0 |        0 |    23.53 |... 66,91,92,95,97 |
|  pledge.js                           |     8.11 |        0 |        0 |     8.11 |... 25,127,128,133 |
|  product.js                          |       20 |        0 |        0 |       20 |... 31,33,34,35,40 |
|  search.js                           |    17.39 |        0 |        0 |    17.39 |... 85,87,88,89,91 |
|  token.js                            |    85.71 |       50 |      100 |    85.71 |                26 |
|  user.js                             |    75.56 |    78.95 |      100 |    75.28 |... 24,325,330,333 |
| shamrock-backend/src/search          |    55.56 |     12.5 |     37.5 |    55.56 |                   |
|  es_client.js                        |      100 |      100 |      100 |      100 |                   |
|  init.js                             |    85.71 |      100 |      100 |    85.71 |             11,12 |
|  queries.js                          |       20 |        0 |        0 |       20 |... 54,61,62,82,83 |
|  schema_mappings.js                  |       75 |       50 |      100 |       75 |              9,10 |
| shamrock-backend/src/utils           |    93.18 |       70 |      100 |    93.02 |                   |
| envVariables.js                     |    88.89 |       50 |      100 |    88.24 |             14,34 |
|  inputValidation.js                  |      100 |      100 |      100 |      100 |                   |
|  security.js                         |    95.65 |      100 |      100 |    95.65 |                38 |
| shamrock-backend/tests/e2e_int_tests |    93.68 |       50 |    98.44 |    93.68 |                   |
|  e2e_utils.js                        |    84.62 |      100 |      100 |    84.62 |             27,28 |
|  search_routes_test.js               |      100 |      100 |      100 |      100 |                   |
|  token_routes_test.js                |      100 |      100 |      100 |      100 |                   |
|  user_routes_test.js                 |    91.67 |       50 |    97.73 |    91.67 |... 37,240,243,289 |
